---
# yaml-language-server: $schema=https://raw.githubusercontent.com/cloudnative-pg/charts/refs/heads/main/charts/cluster/values.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cluster16
  namespace: db
spec:
  releaseName: cluster16
  chart:
    spec:
      chart: cluster
      version: 0.1.0
      sourceRef:
        kind: HelmRepository
        name: cnpg
        namespace: flux-system
  interval: 30m
  install:
    remediation:
      retries: 3
  dependsOn:
    - name: democratic-csi
      namespace: storage-system
  values:
    cluster:
      imageName: ghcr.io/cloudnative-pg/postgresql:16.4-19@sha256:d66c35dc163f69237ca4265042fa2a867ee015af788a584ce02b0808c8b934c9
      instances: 2
      logLevel: warning
      resources:
        requests:
          cpu: 250m
          memory: 256Mi
        limits:
          memory: 512Mi
      storage:
        size: 5Gi
        storageClass: iscsi
      superuserSecret: cloudnative-pg-secret
      monitoring:
        enabled: true
    backups:
      retentionPolicy: 30d
      provider: s3
      barmanObjectStore: &barmanObjectStore
        data:
          compression: bzip2
        wal:
          compression: bzip2
          maxParallel: 8
        destinationPath: s3://cnpg/
        endpointURL: http://minio.storage-system.svc.cluster.local:9000
        # Note: serverName version needs to be incremented
        # when recovering from an existing cnpg cluster
        serverName: cluster16-v1
        s3Credentials:
          accessKeyId:
            name: cloudnative-pg-secret
            key: aws-access-key-id
          secretAccessKey:
            name: cloudnative-pg-secret
            key: aws-secret-access-key
      # Note: previousCluster needs to be set to the name of the previous
      # cluster when recovering from an existing cnpg cluster
    bootstrap:
      recovery:
        source: &previousCluster cluster16-v1
    # Note: externalClusters is needed when recovering from an existing cnpg cluster
    externalClusters:
      - name: *previousCluster
        barmanObjectStore:
          <<: *barmanObjectStore
          serverName: *previousCluster
    postgresql:
      parameters:
        max_connections: "100"
        shared_buffers: 256MB
    # nodeMaintenanceWindow:
    #   inProgress: false
    #   reusePVC: true

