---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: robusta
spec:
  interval: 30m
  chart:
    spec:
      chart: robusta
      version: 0.18.0
      sourceRef:
        kind: HelmRepository
        name: robusta
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    clusterName: talos-cluster
    isSmallCluster: true
    globalConfig:
      signing_key: "{{ env.SIGNKEY }}"
      account_id: "{{ env.ACCOUNTID }}"
    sinksConfig:
      - robusta_sink:
          name: robusta_ui_sink
          token: "{{ env.TOKEN }}"
      - discord_sink:
          name: personal_discord_sink
          url: "{{env.WEBHOOK}}"
    enablePrometheusStack: true
    enablePlatformPlaybooks: true
    runner:
      sendAdditionalTelemetry: true
      additional_env_vars:
        - name: SIGNKEY
          valueFrom:
            secretKeyRef:
              name: robusta-secrets
              key: signing_key
        - name: ACCOUNTID
          valueFrom:
            secretKeyRef:
              name: robusta-secrets
              key: account_id
        - name: TOKEN
          valueFrom:
            secretKeyRef:
              name: robusta-secrets
              key: token
        - name: WEBHOOK
          valueFrom:
            secretKeyRef:
              name: robusta-secrets
              key: webhook
    enableHolmesGPT: true
    holmes:
      additionalEnvVars:
      - name: ROBUSTA_AI
        value: "true"
      additional_env_vars:
      - name: ROBUSTA_UI_TOKEN
        valueFrom:
          secretKeyRef:
            name: robusta-secrets
            key: token
    enabledManagedConfiguration: true # Enable managed alerts
    kube-prometheus-stack: # those rules are now managed by Robusta
      defaultRules:
        rules:
          alertmanager: false
          etcd: false
          configReloaders: false
          general: false
          kubeApiserverSlos: false
          kubeControllerManager: false
          kubeProxy: false
          kubernetesApps: false
          kubernetesResources: false
          kubernetesStorage: false
          kubernetesSystem: false
          kubeSchedulerAlerting: false
          kubeStateMetrics: false
          network: false
          nodeExporterAlerting: false
          prometheus: false
          prometheusOperator: false
      grafana:
        persistence:
          enabled: true
    prometheus:
      prometheusSpec:
        retention: 30d #change the number of days here
