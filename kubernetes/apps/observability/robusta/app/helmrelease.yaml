---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: robusta
spec:
  interval: 30m
  chart:
    spec:
      chart: robusta
      version: 0.18.0
      sourceRef:
        kind: HelmRepository
        name: robusta
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    clusterName: talos-cluster
    isSmallCluster: true
    globalConfig:
      signing_key: "{{ env.SIGNKEY }}"
      account_id: "{{ env.ACCOUNTID }}"
    sinksConfig:
      - robusta_sink:
          name: robusta_ui_sink
          token: "{{ env.TOKEN }}"
    enablePrometheusStack: false
    enablePlatformPlaybooks: true
    runner:
      sendAdditionalTelemetry: true
      additional_env_vars:
        - name: SIGNKEY
          valueFrom:
            secretKeyRef:
              name: robusta-secrets
              key: signing_key
        - name: ACCOUNTID
          valueFrom:
            secretKeyRef:
              name: robusta-secrets
              key: account_id
        - name: TOKEN
          valueFrom:
            secretKeyRef:
              name: robusta-secrets
              key: token
    enableHolmesGPT: true
    holmes:
      additionalEnvVars:
      - name: ROBUSTA_AI
        value: "true"
